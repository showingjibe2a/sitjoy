<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店铺/品牌管理</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .shop-type-bar {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
            padding: 0.45rem 0.6rem;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(2px);
        }
        .shop-type-add {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1px solid rgba(155, 74, 74, 0.2);
            background: #9b4a4a;
            color: #fff;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .shop-type-add:hover {
            filter: brightness(0.95);
        }
        .shop-type-radio input {
            display: none;
        }
        .shop-type-radio span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.55rem 0.95rem;
            border-radius: 8px;
            background: var(--morandi-mist);
            color: var(--morandi-ink);
            border: 1px solid var(--morandi-sand);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }
        .shop-type-radio {
            background: transparent;
            padding: 0;
            margin: 0;
        }
        .shop-type-radio span:hover {
            color: var(--morandi-ink);
            background: rgba(207, 199, 189, 0.55);
        }
        .shop-type-radio input:checked + span {
            background: #9b4a4a;
            color: #fff;
            border-color: #9b4a4a;
        }
        .shop-type-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }
    </style>
</head>
<body>
    <div id="site-header"></div>

    <div class="container">
        <section class="hero" style="margin-bottom: 1.5rem;">
            <h2>店铺 / 品牌管理</h2>
            <p>维护店铺名称、平台类型与品牌信息</p>
        </section>

        <section class="pm-layout">
            <div class="card pm-card">
                <div class="pm-toolbar">
                    <div class="pm-toolbar-actions">
                        <div class="form-group pm-search" style="margin: 0;">
                            <span class="pm-search-title">搜索</span>
                            <input type="text" id="searchInput" placeholder="搜索店铺/平台/品牌">
                            <button class="btn-primary" onclick="loadShopList()">搜索</button>
                            <button class="btn-secondary" onclick="resetSearch()">清空</button>
                        </div>
                        <span class="pm-divider" aria-hidden="true"></span>
                        <button class="btn-accent" onclick="openCreateModal()">新增</button>
                    </div>
                </div>
                <div class="pm-toolbar" style="margin-top: 0.85rem;">
                    <div class="pm-toolbar-actions">
                        <span class="pm-search-title">平台类型管理</span>
                    </div>
                </div>
                <div class="shop-type-bar" id="platformTypeBar" style="margin-top: 0.6rem;">
                    <button class="shop-type-add" type="button" aria-label="新增平台类型" onclick="openPlatformTypeCreateModal()">+</button>
                </div>
                <div class="pm-toolbar" style="margin-top: 0.85rem;">
                    <div class="pm-toolbar-actions">
                        <span class="pm-search-title">品牌管理</span>
                    </div>
                </div>
                <div class="shop-type-bar" id="brandBar" style="margin-top: 0.6rem;">
                    <button class="shop-type-add" type="button" aria-label="新增品牌" onclick="openBrandCreateModal()">+</button>
                </div>
            </div>

            <div>
                <table class="pm-table" id="shopTable">
                    <thead>
                        <tr>
                            <th>店铺名称</th>
                            <th>平台类型</th>
                            <th>品牌</th>
                            <th style="width:180px;">创建时间</th>
                            <th style="width:160px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div class="pm-modal" id="pm-modal">
        <div class="pm-modal-content">
            <h3 id="pm-modal-title" style="margin-top:0;">新增店铺</h3>
            <div class="pm-form">
                <div class="form-group">
                    <label for="modalShopName">店铺名称<span class="required-asterisk">*</span></label>
                    <input type="text" id="modalShopName" class="required-field" placeholder="例如：SITJOY官方店">
                </div>
                <div class="form-group pm-form-full">
                    <label>平台类型<span class="required-asterisk">*</span></label>
                    <div class="shop-type-group" id="modalPlatformType"></div>
                </div>
                <div class="form-group pm-form-full">
                    <label>品牌<span class="required-asterisk">*</span></label>
                    <div class="shop-type-group" id="modalBrand"></div>
                </div>
            </div>
            <div id="modalStatus" class="response" style="display:none; margin-top:0.75rem;"></div>
            <div class="pm-modal-actions">
                <button class="btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn-primary" id="modalSaveBtn" onclick="saveShopFromModal()">保存</button>
            </div>
        </div>
    </div>

    <div class="pm-modal" id="pm-platform-modal">
        <div class="pm-modal-content">
            <h3 id="pm-platform-modal-title" style="margin-top:0;">新增平台类型</h3>
            <div class="pm-form">
                <div class="form-group">
                    <label for="modalPlatformTypeName">平台名<span class="required-asterisk">*</span></label>
                    <input type="text" id="modalPlatformTypeName" class="required-field" placeholder="例如：Amazon">
                </div>
            </div>
            <div id="platformModalStatus" class="response" style="display:none; margin-top:0.75rem;"></div>
            <div class="pm-modal-actions">
                <button class="btn-secondary" onclick="closePlatformTypeModal()">取消</button>
                <button class="btn-primary" id="platformModalSaveBtn" onclick="savePlatformTypeFromModal()">保存</button>
            </div>
        </div>
    </div>

    <div class="pm-modal" id="pm-brand-modal">
        <div class="pm-modal-content">
            <h3 id="pm-brand-modal-title" style="margin-top:0;">新增品牌</h3>
            <div class="pm-form">
                <div class="form-group">
                    <label for="modalBrandName">品牌名<span class="required-asterisk">*</span></label>
                    <input type="text" id="modalBrandName" class="required-field" placeholder="例如：SITJOY">
                </div>
            </div>
            <div id="brandModalStatus" class="response" style="display:none; margin-top:0.75rem;"></div>
            <div class="pm-modal-actions">
                <button class="btn-secondary" onclick="closeBrandModal()">取消</button>
                <button class="btn-primary" id="brandModalSaveBtn" onclick="saveBrandFromModal()">保存</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 SITJOY | 内部使用</p>
    </footer>

    <script>
        let editId = null;
        let editPlatformTypeId = null;
        let editBrandId = null;
        let platformTypeOptions = [];
        let brandOptions = [];
        let pendingPlatformTypeId = null;
        let pendingBrandId = null;
        let activePlatformTypeId = null;
        let activeBrandId = null;

        function showModalStatus(message, isError) {
            const el = document.getElementById('modalStatus');
            el.style.display = 'block';
            el.style.background = isError ? '#ffecec' : '#f0fff0';
            el.style.color = isError ? '#a33' : '#2f6f2f';
            el.innerText = message;
        }

        function resetModalStatus() {
            const el = document.getElementById('modalStatus');
            el.style.display = 'none';
            el.innerText = '';
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            loadShopList();
        }

        function openCreateModal() {
            editId = null;
            document.getElementById('pm-modal-title').innerText = '新增店铺';
            document.getElementById('modalShopName').value = '';
            setPlatformTypeSelect('');
            setBrandSelect('');
            document.getElementById('modalSaveBtn').innerText = '保存';
            resetModalStatus();
            document.getElementById('pm-modal').classList.add('active');
            document.getElementById('modalShopName').focus();
        }

        function openEditModal(item) {
            editId = item.id;
            document.getElementById('pm-modal-title').innerText = '编辑店铺';
            document.getElementById('modalShopName').value = item.shop_name || '';
            setPlatformTypeSelect(item.platform_type_id || '');
            setBrandSelect(item.brand_id || '');
            document.getElementById('modalSaveBtn').innerText = '保存';
            resetModalStatus();
            document.getElementById('pm-modal').classList.add('active');
            document.getElementById('modalShopName').focus();
        }

        function closeModal() {
            document.getElementById('pm-modal').classList.remove('active');
            editId = null;
        }

        function saveShopFromModal() {
            const shopName = document.getElementById('modalShopName').value.trim();
            const platformInput = document.querySelector('input[name="modalPlatformType"]:checked');
            const brandInput = document.querySelector('input[name="modalBrand"]:checked');
            const platformTypeId = platformInput ? platformInput.value : '';
            const brandId = brandInput ? brandInput.value : '';
            if (!shopName || !platformTypeId || !brandId) {
                showModalStatus('请填写店铺名称并选择平台类型与品牌', true);
                return;
            }

            const payload = {
                shop_name: shopName,
                platform_type_id: platformTypeId,
                brand_id: brandId
            };
            let method = 'POST';
            if (editId) {
                payload.id = editId;
                method = 'PUT';
            }

            fetch('/api/shop', {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showModalStatus(editId ? '更新成功' : '新增成功', false);
                    setTimeout(() => {
                        closeModal();
                        loadShopList();
                    }, 400);
                } else {
                    showModalStatus(data.message || '操作失败', true);
                }
            })
            .catch(err => showModalStatus('请求失败: ' + err, true));
        }

        function deleteShop(id) {
            if (!confirm('确认删除该店铺？')) return;
            fetch('/api/shop', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    loadShopList();
                } else {
                    alert(data.message || '删除失败');
                }
            })
            .catch(err => alert('请求失败: ' + err));
        }

        function renderPlatformTypeRadios(selectedValue) {
            const container = document.getElementById('modalPlatformType');
            container.innerHTML = '';
            if (!platformTypeOptions.length) {
                const empty = document.createElement('div');
                empty.style.color = '#6b7280';
                empty.textContent = '暂无平台类型，请先创建';
                container.appendChild(empty);
                return;
            }
            platformTypeOptions.forEach(item => {
                const label = document.createElement('label');
                label.className = 'shop-type-radio';
                label.innerHTML = `
                    <input type="radio" name="modalPlatformType" value="${item.id}">
                    <span>${item.name}</span>
                `;
                const input = label.querySelector('input');
                if (selectedValue && String(selectedValue) === String(item.id)) {
                    input.checked = true;
                }
                container.appendChild(label);
            });
        }

        function renderBrandRadios(selectedValue) {
            const container = document.getElementById('modalBrand');
            container.innerHTML = '';
            if (!brandOptions.length) {
                const empty = document.createElement('div');
                empty.style.color = '#6b7280';
                empty.textContent = '暂无品牌，请先创建';
                container.appendChild(empty);
                return;
            }
            brandOptions.forEach(item => {
                const label = document.createElement('label');
                label.className = 'shop-type-radio';
                label.innerHTML = `
                    <input type="radio" name="modalBrand" value="${item.id}">
                    <span>${item.name}</span>
                `;
                const input = label.querySelector('input');
                if (selectedValue && String(selectedValue) === String(item.id)) {
                    input.checked = true;
                }
                container.appendChild(label);
            });
        }

        function setPlatformTypeSelect(value) {
            if (!platformTypeOptions.length) {
                pendingPlatformTypeId = value || '';
                loadPlatformTypes();
            }
            renderPlatformTypeRadios(value || '');
        }

        function setBrandSelect(value) {
            if (!brandOptions.length) {
                pendingBrandId = value || '';
                loadBrands();
            }
            renderBrandRadios(value || '');
        }

        function loadPlatformTypes() {
            fetch('/api/platform-type')
                .then(r => r.json())
                .then(data => {
                    if (data.status !== 'success') {
                        platformTypeOptions = [];
                        renderPlatformTypeRadios('');
                        renderPlatformTypeBar();
                        return;
                    }
                    platformTypeOptions = data.items || [];
                    const currentValue = pendingPlatformTypeId || (document.querySelector('input[name="modalPlatformType"]:checked') || {}).value || '';
                    pendingPlatformTypeId = null;
                    renderPlatformTypeRadios(currentValue);
                    renderPlatformTypeBar();
                })
                .catch(() => {
                    platformTypeOptions = [];
                    renderPlatformTypeRadios('');
                    renderPlatformTypeBar();
                });
        }

        function loadBrands() {
            fetch('/api/brand')
                .then(r => r.json())
                .then(data => {
                    if (data.status !== 'success') {
                        brandOptions = [];
                        renderBrandRadios('');
                        renderBrandBar();
                        return;
                    }
                    brandOptions = data.items || [];
                    const currentValue = pendingBrandId || (document.querySelector('input[name="modalBrand"]:checked') || {}).value || '';
                    pendingBrandId = null;
                    renderBrandRadios(currentValue);
                    renderBrandBar();
                })
                .catch(() => {
                    brandOptions = [];
                    renderBrandRadios('');
                    renderBrandBar();
                });
        }

        function renderPlatformTypeBar() {
            const bar = document.getElementById('platformTypeBar');
            bar.innerHTML = '';
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'shop-type-add';
            addBtn.setAttribute('aria-label', '新增平台类型');
            addBtn.textContent = '+';
            addBtn.addEventListener('click', openPlatformTypeCreateModal);
            bar.appendChild(addBtn);

            const allLabel = document.createElement('label');
            allLabel.className = 'shop-type-radio';
            allLabel.innerHTML = `
                <input type="radio" name="platformTypeFilter" value="">
                <span>全部</span>
            `;
            const allInput = allLabel.querySelector('input');
            if (!activePlatformTypeId) {
                allInput.checked = true;
            }
            allInput.addEventListener('click', () => {
                activePlatformTypeId = null;
                loadShopList();
            });
            bar.appendChild(allLabel);

            platformTypeOptions.forEach(item => {
                const label = document.createElement('label');
                label.className = 'shop-type-radio';
                label.innerHTML = `
                    <input type="radio" name="platformTypeFilter" value="${item.id}">
                    <span>${item.name}</span>
                `;
                const input = label.querySelector('input');
                if (String(activePlatformTypeId) === String(item.id)) {
                    input.checked = true;
                }
                input.addEventListener('click', () => {
                    activePlatformTypeId = item.id;
                    loadShopList();
                });
                label.addEventListener('dblclick', () => openPlatformTypeEditModal(item));
                bar.appendChild(label);
            });
        }

        function renderBrandBar() {
            const bar = document.getElementById('brandBar');
            bar.innerHTML = '';
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'shop-type-add';
            addBtn.setAttribute('aria-label', '新增品牌');
            addBtn.textContent = '+';
            addBtn.addEventListener('click', openBrandCreateModal);
            bar.appendChild(addBtn);

            const allLabel = document.createElement('label');
            allLabel.className = 'shop-type-radio';
            allLabel.innerHTML = `
                <input type="radio" name="brandFilter" value="">
                <span>全部</span>
            `;
            const allInput = allLabel.querySelector('input');
            if (!activeBrandId) {
                allInput.checked = true;
            }
            allInput.addEventListener('click', () => {
                activeBrandId = null;
                loadShopList();
            });
            bar.appendChild(allLabel);

            brandOptions.forEach(item => {
                const label = document.createElement('label');
                label.className = 'shop-type-radio';
                label.innerHTML = `
                    <input type="radio" name="brandFilter" value="${item.id}">
                    <span>${item.name}</span>
                `;
                const input = label.querySelector('input');
                if (String(activeBrandId) === String(item.id)) {
                    input.checked = true;
                }
                input.addEventListener('click', () => {
                    activeBrandId = item.id;
                    loadShopList();
                });
                label.addEventListener('dblclick', () => openBrandEditModal(item));
                bar.appendChild(label);
            });
        }

        function showPlatformTypeModalStatus(message, isError) {
            const el = document.getElementById('platformModalStatus');
            el.style.display = 'block';
            el.style.background = isError ? '#ffecec' : '#f0fff0';
            el.style.color = isError ? '#a33' : '#2f6f2f';
            el.innerText = message;
        }

        function resetPlatformTypeModalStatus() {
            const el = document.getElementById('platformModalStatus');
            el.style.display = 'none';
            el.innerText = '';
        }

        function openPlatformTypeCreateModal() {
            editPlatformTypeId = null;
            document.getElementById('pm-platform-modal-title').innerText = '新增平台类型';
            document.getElementById('modalPlatformTypeName').value = '';
            document.getElementById('platformModalSaveBtn').innerText = '保存';
            resetPlatformTypeModalStatus();
            document.getElementById('pm-platform-modal').classList.add('active');
            document.getElementById('modalPlatformTypeName').focus();
        }

        function openPlatformTypeEditModal(item) {
            editPlatformTypeId = item.id;
            document.getElementById('pm-platform-modal-title').innerText = '编辑平台类型';
            document.getElementById('modalPlatformTypeName').value = item.name || '';
            document.getElementById('platformModalSaveBtn').innerText = '保存';
            resetPlatformTypeModalStatus();
            document.getElementById('pm-platform-modal').classList.add('active');
            document.getElementById('modalPlatformTypeName').focus();
        }

        function closePlatformTypeModal() {
            document.getElementById('pm-platform-modal').classList.remove('active');
            editPlatformTypeId = null;
        }

        function savePlatformTypeFromModal() {
            const name = document.getElementById('modalPlatformTypeName').value.trim();
            if (!name) {
                showPlatformTypeModalStatus('请填写平台名', true);
                return;
            }

            const payload = { name: name };
            let method = 'POST';
            if (editPlatformTypeId) {
                payload.id = editPlatformTypeId;
                method = 'PUT';
            }

            fetch('/api/platform-type', {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showPlatformTypeModalStatus(editPlatformTypeId ? '更新成功' : '新增成功', false);
                    setTimeout(() => {
                        closePlatformTypeModal();
                        loadPlatformTypes();
                    }, 400);
                } else {
                    showPlatformTypeModalStatus(data.message || '操作失败', true);
                }
            })
            .catch(err => showPlatformTypeModalStatus('请求失败: ' + err, true));
        }

        function showBrandModalStatus(message, isError) {
            const el = document.getElementById('brandModalStatus');
            el.style.display = 'block';
            el.style.background = isError ? '#ffecec' : '#f0fff0';
            el.style.color = isError ? '#a33' : '#2f6f2f';
            el.innerText = message;
        }

        function resetBrandModalStatus() {
            const el = document.getElementById('brandModalStatus');
            el.style.display = 'none';
            el.innerText = '';
        }

        function openBrandCreateModal() {
            editBrandId = null;
            document.getElementById('pm-brand-modal-title').innerText = '新增品牌';
            document.getElementById('modalBrandName').value = '';
            document.getElementById('brandModalSaveBtn').innerText = '保存';
            resetBrandModalStatus();
            document.getElementById('pm-brand-modal').classList.add('active');
            document.getElementById('modalBrandName').focus();
        }

        function openBrandEditModal(item) {
            editBrandId = item.id;
            document.getElementById('pm-brand-modal-title').innerText = '编辑品牌';
            document.getElementById('modalBrandName').value = item.name || '';
            document.getElementById('brandModalSaveBtn').innerText = '保存';
            resetBrandModalStatus();
            document.getElementById('pm-brand-modal').classList.add('active');
            document.getElementById('modalBrandName').focus();
        }

        function closeBrandModal() {
            document.getElementById('pm-brand-modal').classList.remove('active');
            editBrandId = null;
        }

        function saveBrandFromModal() {
            const name = document.getElementById('modalBrandName').value.trim();
            if (!name) {
                showBrandModalStatus('请填写品牌名', true);
                return;
            }

            const payload = { name: name };
            let method = 'POST';
            if (editBrandId) {
                payload.id = editBrandId;
                method = 'PUT';
            }

            fetch('/api/brand', {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showBrandModalStatus(editBrandId ? '更新成功' : '新增成功', false);
                    setTimeout(() => {
                        closeBrandModal();
                        loadBrands();
                    }, 400);
                } else {
                    showBrandModalStatus(data.message || '操作失败', true);
                }
            })
            .catch(err => showBrandModalStatus('请求失败: ' + err, true));
        }

        function renderShopTable(items) {
            const tbody = document.querySelector('#shopTable tbody');
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">暂无数据</td></tr>';
                return;
            }
            tbody.innerHTML = items.map(item => {
                const dateText = item.created_at ? new Date(item.created_at).toLocaleString('zh-CN') : '';
                return `
                    <tr>
                        <td>${item.shop_name || ''}</td>
                        <td>${item.platform_type_name || ''}</td>
                        <td>${item.brand_name || ''}</td>
                        <td>${dateText}</td>
                        <td>
                            <div class="pm-actions">
                                <button class="btn-secondary" onclick='openEditModal(${JSON.stringify(item)})'>编辑</button>
                                <button class="btn-danger" onclick='deleteShop(${item.id})'>删除</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadShopList() {
            const q = document.getElementById('searchInput').value.trim();
            let url = q ? `/api/shop?q=${encodeURIComponent(q)}` : '/api/shop';
            if (activePlatformTypeId) {
                const joiner = url.includes('?') ? '&' : '?';
                url = `${url}${joiner}platform_type_id=${encodeURIComponent(activePlatformTypeId)}`;
            }
            if (activeBrandId) {
                const joiner = url.includes('?') ? '&' : '?';
                url = `${url}${joiner}brand_id=${encodeURIComponent(activeBrandId)}`;
            }
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.querySelector('#shopTable tbody');
                    if (data.status !== 'success') {
                        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#a33;">${data.message || '加载失败'}</td></tr>`;
                        return;
                    }
                    const items = data.items || [];
                    renderShopTable(items);
                })
                .catch(err => {
                    const tbody = document.querySelector('#shopTable tbody');
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#a33;">加载失败: ${err}</td></tr>`;
                });
        }

        window.addEventListener('load', loadPlatformTypes);
        window.addEventListener('load', loadBrands);
        window.addEventListener('load', loadShopList);
        document.getElementById('pm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        document.getElementById('pm-platform-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePlatformTypeModal();
            }
        });
        document.getElementById('pm-brand-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBrandModal();
            }
        });
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                loadShopList();
            }
        });
    </script>
</body>
<script src="/static/js/header.js"></script>
</html>
