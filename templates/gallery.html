<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç®¡ç† - æ–‡ä»¶æµè§ˆå™¨</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div id="site-header"></div>

    <div class="container container--wide">
        <section class="header header-row">
            <div>
                <h2>ğŸ“ æ–‡ä»¶æµè§ˆå™¨</h2>
                <p>ç‚¹å‡»æ–‡ä»¶å¤¹è¿›å…¥ï¼Œç‚¹å‡»å›¾ç‰‡é‡å‘½å</p>
            </div>
        </section>

        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="breadcrumb-row">
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item" onclick="browse('')">ğŸ  æ ¹ç›®å½•</span>
            </div>
            <div class="header-actions">
                <div class="upload-bar">
                    <div class="bar-body upload-left">
                        <input type="file" id="uploadInput" accept="image/*" multiple>
                        <button class="btn-accent" onclick="uploadImages()">ä¸Šä¼ </button>
                    </div>
                    <div id="upload-status" class="upload-status"></div>
                </div>

                <div class="download-bar">
                    <div class="bar-body download-left">
                        <button class="btn-primary" onclick="downloadSelected()">ä¸‹è½½é€‰ä¸­</button>
                    </div>
                    <div id="download-status" class="upload-status"></div>
                </div>
            </div>
        </div>



        <!-- æ–‡ä»¶/æ–‡ä»¶å¤¹ç½‘æ ¼ -->
        <div class="browser-grid" id="browser-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="debug-container" id="debug-container"></div>
    </div>

    <!-- é‡å‘½åå¯¹è¯æ¡† -->
    <div class="rename-dialog" id="rename-dialog">
        <div class="rename-content">
            <h3 style="margin-top: 0;">âœï¸ ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯</h3>
            
            <div class="rename-preview">
                <img id="rename-preview-img" src="" alt="é¢„è§ˆ">
                <button class="preview-zoom" type="button" onclick="openPreviewZoom()" title="æ”¾å¤§æŸ¥çœ‹">ğŸ”</button>
            </div>
            
            <div class="rename-form">
                <div class="form-group">
                    <label>æ–‡ä»¶åï¼ˆæ— éœ€æ‰©å±•åï¼‰</label>
                    <input type="text" id="new-name" placeholder="è¾“å…¥æ–°æ–‡ä»¶å">
                </div>

                <div class="form-group">
                    <label>æ–‡ä»¶å¤¹</label>
                    <div class="folder-picker">
                        <div class="folder-picker-levels" id="target-levels"></div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeRenameDialog()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmRename()">æäº¤ä¿®æ”¹</button>
                </div>
                
                <div id="rename-status" class="status-message" style="display: none;"></div>
            </div>
        </div>
    </div>


    <footer>
        <p>&copy; 2026 SITJOY | å†…éƒ¨ä½¿ç”¨</p>
    </footer>

    <script>
        let currentPath = '';
        let currentRenameImage = null;
        let lastFolders = [];
        let lastImages = [];
        const DEBUG_MODE = true;
        const selectedItems = new Map();

        function decodeB64Utf8(b64) {
            if (!b64) return '';
            try {
                const binary = atob(b64);
                if (typeof TextDecoder !== 'undefined') {
                    const bytes = Uint8Array.from(binary, ch => ch.charCodeAt(0));
                    return new TextDecoder('utf-8').decode(bytes);
                }
                return decodeURIComponent(escape(binary));
            } catch (e) {
                try {
                    return decodeURIComponent(escape(atob(b64)));
                } catch (err) {
                    console.warn('Base64 decode failed:', b64, e);
                    return '';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æµè§ˆæ ¹ç›®å½•
        window.addEventListener('load', function() {
            browse('');
        });

        // æµè§ˆç›®å½•
        function browse(path) {
            currentPath = path;
            const grid = document.getElementById('browser-grid');
            grid.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const debugParam = DEBUG_MODE ? '&debug=1' : '';
            const url = path ? `/api/browse?path=${encodeURIComponent(path)}${debugParam}` : `/api/browse?debug=1`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateBreadcrumb(data.breadcrumbs);
                        lastFolders = data.folders || [];
                        lastImages = data.images || [];
                        displayItems(lastFolders, lastImages);
                        if (DEBUG_MODE && data.debug_items) {
                            renderDebug(data.debug_items, data.total_folders || 0, data.total_images || 0);
                        } else {
                            renderDebug([], data.total_folders || 0, data.total_images || 0);
                        }
                    } else {
                        grid.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½å¤±è´¥: ' + data.message + '</p>';
                        renderDebug([], 0, 0);
                    }
                })
                .catch(error => {
                    console.error('é”™è¯¯:', error);
                    grid.innerHTML = '<p style="color: red; text-align: center;">åŠ è½½é”™è¯¯: ' + error + '</p>';
                    renderDebug([], 0, 0);
                });
        }

        function uploadImages() {
            const input = document.getElementById('uploadInput');
            const status = document.getElementById('upload-status');
            if (!input.files || input.files.length === 0) {
                showStatus(status, 'è¯·é€‰æ‹©å›¾ç‰‡', 'error');
                return;
            }

            const formData = new FormData();
            Array.from(input.files).forEach(file => formData.append('file', file));
            if (currentPath) {
                formData.append('path', currentPath);
            }

            showStatus(status, 'ä¸Šä¼ ä¸­...', 'info');

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(async r => {
                const contentType = r.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    return r.json();
                }
                const text = await r.text();
                throw new Error(text || `HTTP ${r.status}`);
            })
            .then(data => {
                if (data.status === 'success') {
                    showStatus(status, `ä¸Šä¼ å®Œæˆï¼š${data.count} å¼ `, 'success');
                    input.value = '';
                    browse(currentPath);
                } else {
                    showStatus(status, 'ä¸Šä¼ å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(err => {
                showStatus(status, 'ä¸Šä¼ å¤±è´¥: ' + err.message, 'error');
            });
        }

        function renderDebug(items, totalFolders = 0, totalImages = 0) {
            const container = document.getElementById('debug-container');
            const existing = document.getElementById('debug-info');
            if (existing) {
                existing.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.id = 'debug-info';
            wrapper.style.padding = '0.75rem 1rem';
            wrapper.style.background = 'rgba(236, 231, 223, 0.08)';
            wrapper.style.borderRadius = '8px';
            wrapper.style.color = '#cfc7bd';
            wrapper.style.fontSize = '0.85rem';

            const statsLine = `ç»Ÿè®¡ï¼šæ–‡ä»¶å¤¹ ${totalFolders} ä¸ªï¼Œå›¾ç‰‡ ${totalImages} å¼ `;
            const lines = (items || []).slice(0, 50).map(item => {
                const name = item.name || '';
                const reason = item.skipped || 'unknown';
                return `${name}  [${reason}]`;
            });

            wrapper.innerHTML = `
                <div style="font-weight:600; margin-bottom:0.35rem;">${statsLine}</div>
                ${lines.length ? `<div style="margin-top:0.35rem; font-weight:600;">è°ƒè¯•ï¼šè¢«è·³è¿‡çš„æ¡ç›®ï¼ˆæœ€å¤š50æ¡ï¼‰</div>
                <div style="white-space:pre-wrap; word-break:break-all;">${lines.join('\n')}</div>` : ''}
            `;

            container.appendChild(wrapper);
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb(breadcrumbs) {
            const breadcrumbEl = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item" onclick="browse(\'\')">ğŸ  æ ¹ç›®å½•</span>';

            breadcrumbs.forEach(crumb => {
                const name = decodeB64Utf8(crumb.name);
                const path = crumb.path;
                html += '<span class="breadcrumb-separator">â€º</span>';
                html += `<span class="breadcrumb-item" onclick="browse('${path}')">${name}</span>`;
            });

            breadcrumbEl.innerHTML = html;
        }

        function setDownloadStatus(message, type) {
            const status = document.getElementById('download-status');
            showStatus(status, message || '', type || '');
        }

        function showStatus(el, message, type) {
            if (!el) return;
            if (!message) {
                el.textContent = '';
                el.className = 'upload-status';
                el.classList.remove('show');
                return;
            }
            el.textContent = message;
            el.className = 'upload-status ' + (type || '');
            el.classList.add('show');
            clearTimeout(el._hideTimer);
            el._hideTimer = setTimeout(() => {
                el.classList.remove('show');
            }, 2600);
        }

        function toggleSelection(path, type, checked) {
            if (checked) {
                selectedItems.set(path, type);
            } else {
                selectedItems.delete(path);
            }
        }

        async function downloadSelected() {
            if (selectedItems.size === 0) {
                setDownloadStatus('è¯·å…ˆå‹¾é€‰è¦ä¸‹è½½çš„å†…å®¹', 'error');
                return;
            }

            setDownloadStatus('ä¸‹è½½ä¸­...', 'info');
            const payload = [];
            selectedItems.forEach((type, path) => {
                payload.push({ type, path });
            });

            fetch('/api/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: payload })
            })
            .then(async response => {
                const contentType = response.headers.get('content-type') || '';
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }
                if (!contentType.includes('application/zip')) {
                    const text = await response.text();
                    try {
                        const data = JSON.parse(text);
                        throw new Error(data.message || 'ä¸‹è½½å¤±è´¥');
                    } catch (e) {
                        throw new Error(text || 'ä¸‹è½½å¤±è´¥');
                    }
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];
                link.href = url;
                link.download = `sitjoy_download_${timestamp}.zip`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                window.URL.revokeObjectURL(url);
                setDownloadStatus('ä¸‹è½½å·²å¼€å§‹', 'success');
            })
            .catch(err => {
                setDownloadStatus('ä¸‹è½½å¤±è´¥: ' + err.message, 'error');
            });
        }

        // æ˜¾ç¤ºé¡¹ç›®ï¼ˆæ–‡ä»¶å¤¹å’Œå›¾ç‰‡ï¼‰
        function displayItems(folders, images) {
            const grid = document.getElementById('browser-grid');

            if (folders.length === 0 && images.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: white;">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</p>';
                return;
            }

            grid.innerHTML = '';

            // æ˜¾ç¤ºæ–‡ä»¶å¤¹
            folders.forEach(folder => {
                const name = decodeB64Utf8(folder.name);
                const card = document.createElement('div');
                const isSelected = selectedItems.has(folder.path);
                card.className = 'item-card item-card--compact' + (isSelected ? ' item-card--selected' : '');
                card.onclick = () => browse(folder.path);

                card.innerHTML = `
                    <div class="item-select" onclick="event.stopPropagation();">
                        <input type="checkbox" data-path="${folder.path}" data-type="folder" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div class="item-thumbnail folder">
                        <div class="folder-icon">ğŸ“</div>
                    </div>
                    <div class="item-info">
                        <div class="item-name">${name}</div>
                        <div class="item-type">æ–‡ä»¶å¤¹</div>
                    </div>
                `;

                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('click', (e) => e.stopPropagation());
                checkbox.addEventListener('change', (e) => {
                    toggleSelection(folder.path, 'folder', e.target.checked);
                    card.classList.toggle('item-card--selected', e.target.checked);
                });

                grid.appendChild(card);
            });

            // æ˜¾ç¤ºå›¾ç‰‡ï¼ˆå¸¦ç¼©ç•¥å›¾ï¼‰
            images.forEach(image => {
                const name = decodeB64Utf8(image.name);
                const card = document.createElement('div');
                const isSelected = selectedItems.has(image.path);
                card.className = 'item-card item-card--compact' + (isSelected ? ' item-card--selected' : '');
                card.onclick = () => openRenameDialog(image.path, name);

                const thumbnailUrl = `/api/image-preview?id=${encodeURIComponent(image.path)}`;

                card.innerHTML = `
                    <div class="item-select" onclick="event.stopPropagation();">
                        <input type="checkbox" data-path="${image.path}" data-type="image" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div class="item-thumbnail">
                        <img src="${thumbnailUrl}" alt="${name}" loading="lazy">
                    </div>
                    <div class="item-info">
                        <div class="item-name">${name}</div>
                        <div class="item-type">å›¾ç‰‡</div>
                    </div>
                `;

                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('click', (e) => e.stopPropagation());
                checkbox.addEventListener('change', (e) => {
                    toggleSelection(image.path, 'image', e.target.checked);
                    card.classList.toggle('item-card--selected', e.target.checked);
                });

                grid.appendChild(card);
            });
        }

        // æ‰“å¼€é‡å‘½åå¯¹è¯æ¡†
        function openRenameDialog(imagePath, imageName) {
            currentRenameImage = {
                path: imagePath,
                name: imageName
            };

            const currentNameInput = document.getElementById('current-name');
            if (currentNameInput) {
                currentNameInput.value = imageName;
            }
            
            // æå–æ–‡ä»¶åï¼ˆæ— æ‰©å±•åï¼‰
            const nameWithoutExt = imageName.substring(0, imageName.lastIndexOf('.')) || imageName;
            document.getElementById('new-name').value = nameWithoutExt;

            // åŠ è½½é¢„è§ˆå›¾
            const previewImg = document.getElementById('rename-preview-img');
            previewImg.src = `/api/image-preview?id=${encodeURIComponent(imagePath)}`;

            // åŠ è½½å±‚çº§ç›®å½•é€‰æ‹©å™¨ï¼ˆä»æ ¹ç›®å½•å¼€å§‹é€å±‚é€‰æ‹©ï¼‰
            targetFolderPath = '';
            loadFolderLevels('');

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('rename-dialog').classList.add('active');
            document.getElementById('new-name').focus();
            document.getElementById('rename-status').style.display = 'none';
        }

        function utf8ToB64(text) {
            try {
                if (typeof TextEncoder !== 'undefined') {
                    const bytes = new TextEncoder().encode(text);
                    let binary = '';
                    bytes.forEach(b => binary += String.fromCharCode(b));
                    return btoa(binary);
                }
                return btoa(unescape(encodeURIComponent(text)));
            } catch (e) {
                return '';
            }
        }

        function updateTargetPathLabel() {
            return;
        }

        function fetchFolders(pathB64) {
            const url = pathB64 ? `/api/browse?path=${encodeURIComponent(pathB64)}` : '/api/browse';
            return fetch(url)
                .then(r => r.json())
                .then(data => (data.status === 'success' ? (data.folders || []) : []))
                .catch(() => []);
        }

        async function loadFolderLevels(initialPath, autoExpandNext = false) {
            const levels = document.getElementById('target-levels');
            levels.innerHTML = '';
            const parts = initialPath ? initialPath.split('/') : [];
            let currentPathB64 = '';
            let currentPathStr = '';

            for (let level = 0; level <= parts.length; level++) {
                const folders = await fetchFolders(currentPathB64);
                if (folders.length === 0) break;

                const select = document.createElement('select');
                select.dataset.level = String(level);

                const optStay = document.createElement('option');
                optStay.value = '';
                optStay.textContent = 'æ­¤å±‚(ä¸å†æ·±å…¥)';
                select.appendChild(optStay);

                folders.forEach(folder => {
                    const name = decodeB64Utf8(folder.name);
                    const pathStr = decodeB64Utf8(folder.path);
                    const option = document.createElement('option');
                    option.value = folder.path;
                    option.textContent = name;
                    option.dataset.path = pathStr;
                    select.appendChild(option);
                });

                select.addEventListener('change', () => handleFolderLevelChange(level));
                levels.appendChild(select);

                if (level < parts.length) {
                    const targetPathStr = parts.slice(0, level + 1).join('/');
                    const match = Array.from(select.options).find(o => o.dataset.path === targetPathStr);
                    if (match) {
                        select.value = match.value;
                        currentPathB64 = match.value;
                        currentPathStr = match.dataset.path || '';
                        continue;
                    }
                }
                break;
            }

            targetFolderPath = currentPathStr || '';
            updateTargetPathLabel();

            if (autoExpandNext) {
                const nextFolders = await fetchFolders(currentPathB64);
                if (nextFolders.length > 0) {
                    const nextLevel = parts.length + 1;
                    const nextSelect = document.createElement('select');
                    nextSelect.dataset.level = String(nextLevel);
                    const optStay = document.createElement('option');
                    optStay.value = '';
                    optStay.textContent = 'æ­¤å±‚(ä¸å†æ·±å…¥)';
                    nextSelect.appendChild(optStay);
                    nextFolders.forEach(folder => {
                        const name = decodeB64Utf8(folder.name);
                        const pathStr = decodeB64Utf8(folder.path);
                        const option = document.createElement('option');
                        option.value = folder.path;
                        option.textContent = name;
                        option.dataset.path = pathStr;
                        nextSelect.appendChild(option);
                    });
                    nextSelect.addEventListener('change', () => handleFolderLevelChange(nextLevel));
                    levels.appendChild(nextSelect);
                }
            }
        }

        function handleFolderLevelChange(level) {
            const levels = document.getElementById('target-levels');
            const selects = Array.from(levels.querySelectorAll('select'));
            selects.forEach(sel => {
                if (parseInt(sel.dataset.level, 10) > level) {
                    sel.remove();
                }
            });

            const current = levels.querySelector(`select[data-level="${level}"]`);
            const selectedOption = current ? current.selectedOptions[0] : null;
            if (!selectedOption || !selectedOption.value) {
                targetFolderPath = getSelectedPathFromLevels(levels);
                updateTargetPathLabel();
                return;
            }

            targetFolderPath = selectedOption.dataset.path || '';
            updateTargetPathLabel();

            fetchFolders(selectedOption.value).then(folders => {
                if (folders.length === 0) return;
                const nextLevel = level + 1;
                const nextSelect = document.createElement('select');
                nextSelect.dataset.level = String(nextLevel);
                const optStay = document.createElement('option');
                optStay.value = '';
                optStay.textContent = 'æ­¤å±‚(ä¸å†æ·±å…¥)';
                nextSelect.appendChild(optStay);
                folders.forEach(folder => {
                    const name = decodeB64Utf8(folder.name);
                    const pathStr = decodeB64Utf8(folder.path);
                    const option = document.createElement('option');
                    option.value = folder.path;
                    option.textContent = name;
                    option.dataset.path = pathStr;
                    nextSelect.appendChild(option);
                });
                nextSelect.addEventListener('change', () => handleFolderLevelChange(nextLevel));
                levels.appendChild(nextSelect);
            });
        }

        function getSelectedPathFromLevels(levels) {
            let path = '';
            const selects = Array.from(levels.querySelectorAll('select'));
            for (const sel of selects) {
                const opt = sel.selectedOptions[0];
                if (!opt || !opt.dataset.path) break;
                path = opt.dataset.path;
            }
            return path;
        }

        function openPreviewZoom() {
            if (!currentRenameImage) return;
            window.open(`/api/image-preview?id=${encodeURIComponent(currentRenameImage.path)}`, '_blank');
        }

        // ç¡®è®¤é‡å‘½å
        function confirmRename() {
            if (!currentRenameImage) return;

            let newName = document.getElementById('new-name').value.trim();
            const statusDiv = document.getElementById('rename-status');

            const oldNameWithoutExt = currentRenameImage.name.substring(0, currentRenameImage.name.lastIndexOf('.')) || currentRenameImage.name;
            if (!newName) newName = oldNameWithoutExt;

            const decodedPath = decodeB64Utf8(currentRenameImage.path) || '';
            const lastSlash = decodedPath.lastIndexOf('/');
            const currentFolderPath = lastSlash >= 0 ? decodedPath.slice(0, lastSlash) : '';

            if (newName === oldNameWithoutExt && targetFolderPath === currentFolderPath) {
                statusDiv.textContent = 'æœªåšä»»ä½•ä¿®æ”¹';
                statusDiv.className = 'status-message error';
                statusDiv.style.display = 'block';
                return;
            }

            statusDiv.textContent = 'é‡å‘½åä¸­...';
            statusDiv.className = 'status-message info';
            statusDiv.style.display = 'block';

            // Base64ç¼–ç æ–°æ–‡ä»¶å
            const newNameB64 = utf8ToB64(newName);
            const targetFolderB64 = targetFolderPath ? utf8ToB64(targetFolderPath) : '';

            fetch('/api/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: currentRenameImage.path,
                    new_name_b64: newNameB64,
                    target_folder_b64: targetFolderB64
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.textContent = 'âœ“ é‡å‘½åæˆåŠŸï¼';
                    statusDiv.className = 'status-message success';
                    setTimeout(() => {
                        closeRenameDialog();
                        browse(currentPath); // åˆ·æ–°å½“å‰ç›®å½•
                    }, 1000);
                } else {
                    statusDiv.textContent = 'âœ— é‡å‘½åå¤±è´¥: ' + data.message;
                    statusDiv.className = 'status-message error';
                }
            })
            .catch(error => {
                statusDiv.textContent = 'âœ— é”™è¯¯: ' + error;
                statusDiv.className = 'status-message error';
            });
        }

        // å›è½¦é”®æäº¤
        document.getElementById('new-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmRename();
            }
        });

        // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('rename-dialog').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRenameDialog();
            }
        });

        // ESCé”®å…³é—­å¯¹è¯æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRenameDialog();
            }
        });
    </script>
</body>
    <script src="/static/js/header.js"></script>
</html>
