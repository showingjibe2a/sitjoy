<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç®¡ç† - é¢„è§ˆå’Œé‡å‘½å</title>
    <link rel="stylesheet" href="/static/css/gallery.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ</h1>
            <ul class="nav-menu">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/gallery" class="active">å›¾ç‰‡ç®¡ç†</a></li>
                <li><a href="/about">å…³äº</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <section class="header">
            <h2>å›¾ç‰‡é¢„è§ˆå’Œå¿«é€Ÿé‡å‘½å</h2>
            <p>ç‚¹å‡»å›¾ç‰‡é¢„è§ˆï¼Œç›´æ¥åœ¨ä¸‹æ–¹é‡å‘½å</p>
        </section>

        <!-- å›¾ç‰‡åˆ—è¡¨ -->
        <div id="images-grid" class="images-grid">
            <div class="loading">åŠ è½½å›¾ç‰‡ä¸­...</div>
        </div>

        <!-- é¢„è§ˆå’Œé‡å‘½åé¢æ¿ -->
        <div id="preview-panel" class="preview-panel" style="display: none;">
            <button class="close-btn" onclick="closePreview()">âœ•</button>
            
            <div class="preview-container">
                <div class="preview-image">
                    <img id="preview-img" src="" alt="é¢„è§ˆ">
                </div>
                
                <div class="preview-info">
                    <div class="info-group">
                        <label>å½“å‰æ–‡ä»¶å</label>
                        <input type="text" id="current-filename" readonly>
                    </div>
                    
                    <div class="info-group">
                        <label>æ–‡ä»¶è·¯å¾„</label>
                        <input type="text" id="file-path" readonly style="font-size: 12px;">
                    </div>
                    
                    <div class="info-group">
                        <label>æ–°æ–‡ä»¶å</label>
                        <input type="text" id="new-filename" placeholder="è¾“å…¥æ–°çš„æ–‡ä»¶åï¼ˆä¸éœ€è¦æ‰©å±•åï¼‰">
                    </div>
                    
                    <button class="rename-btn" onclick="renameFile()">åº”ç”¨é‡å‘½å</button>
                    <div id="rename-status" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ | Synology NAS</p>
    </footer>

    <script>
        let currentFile = null;
        let allImages = [];
        let currentPage = 1;
        let totalPages = 1;

        // é¡µé¢åŠ è½½æ—¶è·å–å›¾ç‰‡åˆ—è¡¨
        window.addEventListener('load', function() {
            loadImages(1);
        });

        function loadImages(page = 1) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '<div class="loading">åŠ è½½å›¾ç‰‡ä¸­...</div>';

            fetch(`/api/images?page=${page}&per_page=50`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentPage = data.page;
                        totalPages = data.pages;
                        allImages = data.images;
                        displayImages(data.images);
                        displayPagination(data);
                    } else {
                        grid.innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥: ' + data.message + '</p>';
                    }
                })
                .catch(error => {
                    console.error('é”™è¯¯:', error);
                    grid.innerHTML = '<p style="color: red;">åŠ è½½é”™è¯¯: ' + error + '</p>';
                });
        }

        function displayImages(images) {
            const grid = document.getElementById('images-grid');
            
            if (images.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1;">æœªæ‰¾åˆ°å›¾ç‰‡</p>';
                return;
            }

            grid.innerHTML = '';
            
            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'image-item';
                const filename = atob(image.filename);  // è§£ç Base64
                const folder = atob(image.folder);
                
                item.innerHTML = `
                    <div class="image-thumbnail" onclick="previewImage('${image.id}', '${image.filename}')">
                        <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect fill='%23f0f0f0' width='200' height='200'/><text x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='14' fill='%23999'>ç‚¹å‡»é¢„è§ˆ</text></svg>" 
                             alt="${filename}"
                             loading="lazy">
                    </div>
                    <div class="image-name" title="${filename}">${filename}</div>
                    <div class="image-folder" title="${folder}">${folder}</div>
                `;
                grid.appendChild(item);
            });
        }

        function displayPagination(data) {
            let paginationHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: white;">`;
            
            // ä¸Šä¸€é¡µ
            if (data.page > 1) {
                paginationHTML += `<button onclick="loadImages(${data.page - 1})" class="pagination-btn">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç ä¿¡æ¯
            paginationHTML += `<span style="margin: 0 1rem;">ç¬¬ ${data.page} / ${data.pages} é¡µ (å…± ${data.total} å¼ å›¾ç‰‡)</span>`;
            
            // ä¸‹ä¸€é¡µ
            if (data.page < data.pages) {
                paginationHTML += `<button onclick="loadImages(${data.page + 1})" class="pagination-btn">ä¸‹ä¸€é¡µ</button>`;
            }
            
            paginationHTML += `</div>`;
            
            const grid = document.getElementById('images-grid');
            grid.innerHTML += paginationHTML;
        }

        function previewImage(id, filenameB64) {
            const filename = atob(filenameB64);
            currentFile = {
                id: id,
                filename: filename,
                filenameB64: filenameB64
            };

            document.getElementById('current-filename').value = filename;
            document.getElementById('file-path').value = id;
            
            // é¢„å¡«æ–°æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
            const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.')) || filename;
            document.getElementById('new-filename').value = nameWithoutExt;
            document.getElementById('rename-status').innerHTML = '<p style="color: #666;">åŠ è½½é¢„è§ˆä¸­...</p>';
            
            // åŠ è½½é¢„è§ˆ
            const previewImg = document.getElementById('preview-img');
            previewImg.src = `/api/image-preview?id=${encodeURIComponent(id)}`;
            previewImg.onerror = function() {
                document.getElementById('rename-status').innerHTML = '<p style="color: orange;">é¢„è§ˆåŠ è½½å¤±è´¥ï¼Œä½†å¯ç»§ç»­é‡å‘½å</p>';
            };
            previewImg.onload = function() {
                document.getElementById('rename-status').innerHTML = '';
            };
            
            document.getElementById('preview-panel').style.display = 'block';
        }

        function closePreview() {
            document.getElementById('preview-panel').style.display = 'none';
            currentFile = null;
        }

        function renameFile() {
            if (!currentFile) return;
            
            const newName = document.getElementById('new-filename').value.trim();
            const statusDiv = document.getElementById('rename-status');
            
            if (!newName) {
                statusDiv.innerHTML = '<p style="color: orange;">è¯·è¾“å…¥æ–°æ–‡ä»¶å</p>';
                return;
            }
            
            if (newName === currentFile.filename) {
                statusDiv.innerHTML = '<p style="color: orange;">æ–°æ–‡ä»¶åä¸åŸæ–‡ä»¶åç›¸åŒ</p>';
                return;
            }

            statusDiv.innerHTML = '<p style="color: #666;">é‡å‘½åä¸­...</p>';

            // æ–°åç§°ä¹Ÿç”¨Base64ç¼–ç 
            const newNameB64 = btoa(unescape(encodeURIComponent(newName)));

            fetch('/api/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: currentFile.id,
                    new_name_b64: newNameB64
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<p style="color: green;">âœ“ ' + data.message + '</p>';
                    setTimeout(() => {
                        loadImages(currentPage);
                        closePreview();
                    }, 1500);
                } else {
                    statusDiv.innerHTML = '<p style="color: red;">âœ— é‡å‘½åå¤±è´¥: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                statusDiv.innerHTML = '<p style="color: red;">âœ— é”™è¯¯: ' + error + '</p>';
            });
        }

        // å›è½¦é”®æäº¤é‡å‘½å
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && currentFile && document.activeElement.id === 'new-filename') {
                renameFile();
            }
        });

        // ç‚¹å‡»é¢æ¿å¤–å…³é—­
        document.getElementById('preview-panel').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });
    </script>
</body>
</html>
